/*
 mixin_subscriptions.js
 (c) 2011 Kevin Malakoff.
 Mixin.Subscriptions is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/mixin/blob/master/LICENSE
 Dependencies: Mixin.Core, Underscore.js, Underscore-Awesomer.js
*/
if(!Mixin&&(typeof exports!=="undefined")){this.Mixin=require("mixin_core").Mixin}if(!Mixin){throw new Error("Mixin.Subscriptions: Dependency alert! Mixin is missing. Please ensure it is included")}if(!_.VERSION){throw new Error("Mixin.Subscriptions: Dependency alert! Underscore.js must be included before this file")}if(!_.AWESOMENESS){throw new Error("Mixin.Subscriptions: Dependency alert! Underscore-Awesomer.js must be included before this file")}Mixin.Subscriptions||(Mixin.Subscriptions={});Mixin.Subscriptions._SubscriptionLink=(function(){function a(f,d,e,b){var c;this.subscription=f;this.subscriber=d;this.notification_callback=e;this.options=_.clone(b||{});c=Mixin.instanceData(this.subscriber,"Subscriber");c.subscription_backlinks.push(this)}a.prototype.mustKeepUntilDestroyed=function(){return(this.options.keep_until_destroyed===void 0)||!this.options.keep_until_destroyed};a.prototype.destroy=function(){var b;if(!this.subscription){throw new Error("Mixin.Subscriptions: _SubscriptionLink destroyed multiple times")}if(this.options.destroy){this.options.destroy();this.options.destroy=null}b=Mixin.instanceData(this.subscriber,"Subscriber");_.remove(b.subscription_backlinks,this);_.remove(this.subscription.subscription_links,this);this.subscription=null;this.subscriber=null;this.notification_callback=null;return this.options=null};return a})();Mixin.Subscription||(Mixin.Subscription={});Mixin.Subscription.TYPE={};Mixin.Subscription.TYPE.MULTIPLE=0;Mixin.Subscription.TYPE.EXCLUSIVE=1;Mixin.Subscriptions._Subscription=(function(){function a(c,b){this.observable=c;this.subscription_type=b;if(Mixin.DEBUG){if((typeof this.subscription_type!=="number")||(this.subscription_type<Mixin.Subscription.TYPE.MULTIPLE)||(this.subscription_type>Mixin.Subscription.TYPE.EXCLUSIVE)){throw new Error("Mixin.Subscriptions: Mixin.Subscription.TYPE is invalid")}}this.subscription_links=[]}a.prototype.addSubscriber=function(c,d,b){if(this.subscription_type===Mixin.Subscription.TYPE.EXCLUSIVE){this.removeSubscribers(function(e){return e.mustKeepUntilDestroyed()})}return this.subscription_links.push(new Mixin.Subscriptions._SubscriptionLink(this,c,d,b))};a.prototype.removeSubscriber=function(c,d,b){var e;e=_.find(this.subscription_links,function(f){return(c===f.subscriber)&&(d===f.notification_callback)});if(!e){throw new Error("Mixin.Subscriptions.removeSubscriber: subscription '"+b+"' does not exist for '"+(_.classOf(c))+"'")}_.remove(this.subscription_links,e);return e.destroy()};a.prototype.subscribers=function(g){var f,e,c,d,b;d=this.subscription_links;b=[];for(e=0,c=d.length;e<c;e++){f=d[e];b.push(g.push(f.subscriber))}return b};a.prototype.notifySubscribers=function(){var d,g,f,c,e,b;d=Array.prototype.slice.call(arguments);e=this.subscription_links;b=[];for(f=0,c=e.length;f<c;f++){g=e[f];b.push(g.notification_callback.apply(g.subscriber,d))}return b};a.prototype.removeSubscribers=function(b){var d,j,h,f,i,c,g,e;if(b){d=_.select(this.subscription_links,b);if(d.length===0){return}this.subscription_links=_.difference(this.subscription_links,d);g=[];for(h=0,i=d.length;h<i;h++){j=d[h];g.push(j.destroy())}return g}else{d=this.subscription_links;this.subscription_links=[];e=[];for(f=0,c=d.length;f<c;f++){j=d[f];e.push(j.destroy())}return e}};a.prototype.destroy=function(){return _.remove(this.subscription_links,void 0,{callback:(function(b){return b.destroy()}),preclear:true})};return a})();Mixin.Subscriptions.Observable||(Mixin.Subscriptions.Observable={});Mixin.Subscriptions.Observable._mixin_info={mixin_name:"Observable",initialize:function(){var a,d,c,b;Mixin.instanceData(this,"Observable",{subscriptions:{},is_destroyed:false});b=[];for(d=0,c=arguments.length;d<c;d++){a=arguments[d];b.push(this.addSubscription.apply(this,_.isArray(a)?a:[a]))}return b},destroy:function(){var a;a=Mixin.instanceData(this,"Observable");if(a.is_destroyed){throw new Error("Mixin.Observable.destroy: already destroyed")}a.is_destroyed=true;return _.remove(a.subscriptions,void 0,{callback:(function(b){return b.destroy()})})},mixin_object:{hasSubscription:function(a){var b;if(Mixin.DEBUG){Mixin.Core._Validate.string(a,"Mixin.Observable.hasSubscription","subscription_name")}b=Mixin.instanceData(this,"Observable");return b.subscriptions.hasOwnProperty(a)},addSubscription:function(a,b){var c;c=Mixin.instanceData(this,"Observable");if(b===void 0){b=Mixin.Subscription.TYPE.MULTIPLE}if(Mixin.DEBUG){Mixin.Core._Validate.string(a,"Mixin.Observable.addSubscription","subscription_name");Mixin.Core._Validate.noKey(c.subscriptions,a,"Mixin.Observable.addSubscription","subscription_name")}c.subscriptions[a]=new Mixin.Subscriptions._Subscription(this,b);return this},subscriptions:function(){var e,a,d,c,b;e=Mixin.instanceData(this,"Observable");d=[];b=e.subscriptions;for(a in b){c=b[a];d.push(a)}return d},subscribers:function(b){var g,a,e,c,d,f;e=[];g=Mixin.instanceData(this,"Observable");if(b===void 0){d=g.subscriptions;for(a in d){c=d[a];c.subscribers(e)}}else{if(!g.subscriptions.hasOwnProperty(b)){throw new Error("Mixin.Observable.subscribers: subscriber '"+(_classOf(this))+"' does not recognize '"+b+"'")}f=g.subscriptions;for(a in f){c=f[a];if(c.subscription_name===b){c.subscribers(e)}}}return _.uniq(e)},addSubscriber:function(h,d){var e,a,c,g,i,b,f;c=Mixin.instanceData(this,"Observable");i=function(k,m,j){var l;j||(j={});if(Mixin.DEBUG){Mixin.Core._Validate.string(k,"Mixin.Observable.addSubscriber","subscription_name");Mixin.Core._Validate.callback(m,"Mixin.Observable.addSubscriber","notification_callback");Mixin.Core._Validate.object(j,"Mixin.Observable.addSubscriber","options");if(j.destroy!==void 0){Mixin.Core._Validate.callback(j.destroy,"Mixin.Observable.addSubscriber","options.destroy")}}Mixin.Core._Validate.hasKey(c.subscriptions,k,"Mixin.Observable.addSubscriber","subscription_name");l=c.subscriptions[k];return l.addSubscriber(h,m,j)};e=Array.prototype.slice.call(arguments,1);Mixin.Core._Validate.instanceWithMixin(h,"Subscriber","Mixin.Observable.addSubscriber","subscriber");if(e.length>1){a=e[1];if(!((_.isString(a)&&this.hasSubscription(a))||(_.isArray(a)&&(a.length>=1)&&_.isString(a[0])&&this.hasSubscription(a[0])))){i.apply(this,Array.prototype.slice.call(arguments,1));return this}}for(b=0,f=e.length;b<f;b++){g=e[b];if(_.isArray(g)){i.apply(this,g)}else{i.apply(g)}}return this},notifySubscribers:function(a){var c,b;c=Mixin.instanceData(this,"Observable");if(c.is_destroyed){return}if(Mixin.DEBUG){Mixin.Core._Validate.string(a,"Mixin.Observable.notifySubscribers","subscription_name");Mixin.Core._Validate.hasKey(c.subscriptions,a,"Mixin.Observable.notifySubscribers")}b=c.subscriptions[a];if(!b){return}b.notifySubscribers.apply(b,Array.prototype.slice.call(arguments,1));return this},removeSubscriber:function(j,c,a){var g,d,f,i,b,e,h;f=Mixin.instanceData(this,"Observable");b=function(k,m){var l;if(Mixin.DEBUG){Mixin.Core._Validate.string(k,"Mixin.Observable.removeSubscriber","subscription_name");Mixin.Core._Validate.callback(m,"Mixin.Observable.removeSubscriber","notification_callback")}Mixin.Core._Validate.hasKey(f.subscriptions,k,"Mixin.Observable.removeSubscriber","subscription_name");l=f.subscriptions[k];return l.removeSubscriber(j,m,k)};g=Array.prototype.slice.call(arguments,1);if(Mixin.DEBUG){Mixin.Core._Validate.instanceWithMixin(j,"Subscriber","Mixin.Observable.removeSubscriber","subscriber")}if(g.length>1){d=g[1];if(!((_.isString(d)&&this.hasSubscription(d))||(_.isArray(d)&&(d.length>=1)&&_.isString(d[0])&&this.hasSubscription(d[0])))){b.apply(this,Array.prototype.slice.call(arguments,1));return this}}for(e=0,h=g.length;e<h;e++){i=g[e];if(_.isArray(i)){b.apply(this,i)}else{b.apply(i)}}return this},removeSubscribers:function(b,e){var f,a,c,d;f=Mixin.instanceData(this,"Observable");if(Mixin.DEBUG){if(b!==void 0){Mixin.Core._Validate.string(b,"Mixin.Observable.removeSubscribers","subscription_name");Mixin.Core._Validate.hasKey(f.subscriptions,b,"Mixin.Observable.removeSubscribers")}if(e!==void 0){Mixin.Core._Validate.callback(e,"Mixin.Observable.removeSubscribers","test_fn")}}if(b){c=f.subscriptions[b];if(!c){return}c.removeSubscribers(e)}else{d=f.subscriptions;for(a in d){c=d[a];c.removeSubscribers(e)}}return this}}};Mixin.Subscriptions.Subscriber||(Mixin.Subscriptions.Subscriber={});Mixin.Subscriptions.Subscriber._mixin_info={mixin_name:"Subscriber",initialize:function(){return Mixin.instanceData(this,"Subscriber",{subscription_backlinks:[],is_destroyed:false})},destroy:function(){var a;a=Mixin.instanceData(this,"Subscriber");if(a.is_destroyed){throw new Error("Mixin.Subscriber.destroy: already destroyed")}a.is_destroyed=true;return _.remove(a.subscription_backlinks,void 0,{callback:(function(b){return b.destroy()}),preclear:true})},mixin_object:{observables:function(b){var h,d,j,f,e,i,a,g,c;h=Mixin.instanceData(this,"Subscriber");d=[];if(b===void 0){g=h.subscription_backlinks;for(f=0,i=g.length;f<i;f++){j=g[f];if(j.subscription&&(j.subscription.subscription_name===b)){d.push(j.subscription.observable)}}}else{if(Mixin.DEBUG){Mixin.Core._Validate.string(b,"Mixin.Subscriptions.observables","subscription_name")}c=h.subscription_backlinks;for(e=0,a=c.length;e<a;e++){j=c[e];if(j.subscription){d.push(j.subscription.observable)}}}return _.uniq(d)}}};Mixin.Subscriptions.ObservableSubscriber||(Mixin.Subscriptions.ObservableSubscriber={});Mixin.Subscriptions.ObservableSubscriber._mixin_info={mixin_name:"ObservableSubscriber",mixin_object:{},initialize:function(){return Mixin["in"](this,"Subscriber",["Observable"].concat(Array.prototype.slice.call(arguments)))},destroy:function(){return Mixin.out(this,"Subscriber","Observable")}};Mixin.registerMixin(Mixin.Subscriptions.Observable._mixin_info);Mixin.registerMixin(Mixin.Subscriptions.Subscriber._mixin_info);Mixin.registerMixin(Mixin.Subscriptions.ObservableSubscriber._mixin_info);