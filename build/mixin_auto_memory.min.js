/*
 mixin_auto_memory.js
 (c) 2011 Kevin Malakoff.
 Mixin.AutoMemory is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/mixin/blob/master/LICENSE
 Dependencies: Mixin.Core, Underscore.js, Underscore-Awesomer.js
*/
if(!Mixin&&(typeof exports!=="undefined")){this.Mixin=require("mixin_core").Mixin}if(!Mixin){throw new Error("Mixin.AutoMemory: Dependency alert! Mixin is missing. Please ensure it is included")}if(!_.VERSION){throw new Error("Mixin.AutoMemory: Dependency alert! Underscore.js must be included before this file")}if(!_.AWESOMENESS){throw new Error("Mixin.AutoMemory: Dependency alert! Underscore-Awesomer.js must be included before this file")}Mixin.AutoMemory||(Mixin.AutoMemory={});Mixin.AutoMemory.root=this;Mixin.AutoMemory.WRAPPER=Mixin.AutoMemory.root["$"]?$:"$";Mixin.AutoMemory.Property=(function(){function a(b){this.owner=b}a.prototype.setArgs=function(){var f,e,c,d,b;if(!arguments.length){throw new Error("Mixin.AutoMemory: missing key")}this.args=Array.prototype.slice.call(arguments);if(!Mixin.DEBUG){return this}if(_.isArray(this.args[0])){d=this.args;b=[];for(e=0,c=d.length;e<c;e++){f=d[e];b.push(this._validateEntry(f))}return b}else{return this._validateEntry(this.args)}};a.prototype.destroy=function(){var f,e,c,d,b;if(_.isArray(this.args[0])){d=this.args;b=[];for(e=0,c=d.length;e<c;e++){f=d[e];b.push(this._destroyEntry(f))}return b}else{return this._destroyEntry(this.args)}};a.prototype._validateEntry=function(d){var c,b;b=d[0];c=d.length>1?d[1]:void 0;if(!_.keypathExists(this.owner,b)){throw new Error("Mixin.AutoMemory: property '"+b+"' doesn't exist on '"+(_.classOf(this.owner))+"'")}if(c&&!(_.isFunction(c)||_.isString(c))){throw new Error("Mixin.AutoMemory: unexpected function reference for property '"+b+"' on '"+(_.classOf(this.owner))+"'")}};a.prototype._destroyEntry=function(g){var b,i,j,h,f,c,e,d;i=g[0];b=g.length>1?g[1]:void 0;if(!b){j=_.keypathValueOwner(this.owner,i);if(!j){throw new Error("Mixin.AutoMemory: property '"+i+"' doesn't exist on '"+(_.classOf(this.owner))+"'")}j[i]=null;return}f=_.keypath(this.owner,i);if(!f){return}if(_.isFunction(b)){b.apply(this.owner,[f].concat(g.length>2?g.slice(2):[]))}else{if(_.isFunction(f[b])){f[b].apply(f,g.length>2?g.slice(2):[])}else{d=g.slice(1);for(c=0,e=d.length;c<e;c++){h=d[c];this._destroyEntry([h])}}}return _.keypath(this.owner,i,null)};return a})();Mixin.AutoMemory.WrappedProperty=(function(){function a(b,d,e,h){var g,c,f;this.owner=b;this.key=d;this.fn_ref=e;this.wrapper=h;if(this.fn_ref&&_.isArray(this.fn_ref)){if(Mixin.DEBUG&&!this.fn_ref.length){throw new Error("Mixin.AutoMemory: unexpected function reference")}this.args=this.fn_ref.splice(1);this.fn_ref=this.fn_ref[0]}if(!Mixin.DEBUG){return this}if(!this.key){throw new Error("Mixin.AutoMemory: missing key")}if(_.isArray(this.key)){f=this.key;for(g=0,c=f.length;g<c;g++){d=f[g];if(!_.keypathExists(this.owner,d)){throw new Error("Mixin.AutoMemory: property '"+d+"' doesn't exist on '"+(_.classOf(this.owner))+"'")}}}else{if(!_.keypathExists(this.owner,this.key)){throw new Error("Mixin.AutoMemory: property '"+this.key+"' doesn't exist on '"+(_.classOf(this.owner))+"'")}}if(this.fn_ref&&!(_.isFunction(this.fn_ref)||_.isString(this.fn_ref))){throw new Error("Mixin.AutoMemory: unexpected function reference")}if(!this.wrapper){throw new Error("Mixin.AutoMemory: missing wrapper")}}a.prototype.destroy=function(){var d,f,c,e,b;if(_.isArray(this.key)){e=this.key;b=[];for(f=0,c=e.length;f<c;f++){d=e[f];b.push(this._destroyKey(d))}return b}else{return this._destroyKey(this.key)}};a.prototype._destroyKey=function(b){var d,c,e;if(!this.fn_ref){_.keypath(this.owner,b,null);return}d=_.keypath(this.owner,b);if(!d){return}e=_.isString(this.wrapper)?Mixin.AutoMemory.root[this.wrapper]:this.wrapper;c=e(d);if(_.isFunction(this.fn_ref)){this.fn_ref.apply(this.owner,[c].concat(this.args?this.args.slice():[]))}else{if(Mixin.DEBUG&&!_.isFunction(c[this.fn_ref])){throw new Error("Mixin.AutoMemory: function '"+this.fn_ref+"' missing for wrapped property '"+b+"' on '"+(_.classOf(this.owner))+"'")}c[this.fn_ref].apply(c,this.args)}return _.keypath(this.owner,b,null)};return a})();Mixin.AutoMemory.Function=(function(){function a(c,d,b){this.object=c;this.fn_ref=d;this.args=b;if(!Mixin.DEBUG){return this}if(!this.fn_ref){throw new Error("Mixin.AutoMemory: missing fn_ref")}if(!_.isFunction(this.fn_ref)&&!(this.object&&_.isString(this.fn_ref)&&_.isFunction(this.object[this.fn_ref]))){throw new Error("Mixin.AutoMemory: unexpected function reference")}}a.prototype.destroy=function(){if(!this.object){this.fn_ref.apply(null,this.args);return}if(!_.isFunction(this.fn_ref)){this.object[this.fn_ref].apply(this.object,this.args);return}return this.fn_ref.apply(this.object,[this.object].concat(this.args?this.args.slice():[]))};return a})();Mixin.AutoMemory._mixin_info={mixin_name:"AutoMemory",initialize:function(){return Mixin.instanceData(this,"AutoMemory",[])},destroy:function(){var e,c,d,b,a;c=Mixin.instanceData(this,"AutoMemory");Mixin.instanceData(this,"AutoMemory",[]);a=[];for(d=0,b=c.length;d<b;d++){e=c[d];a.push(e.destroy())}return a},mixin_object:{autoProperty:function(b,c){var a;a=new Mixin.AutoMemory.Property(this);a.setArgs.apply(a,arguments);Mixin.instanceData(this,"AutoMemory").push(a);return this},autoWrappedProperty:function(a,b,c){if(c===void 0){c=Mixin.AutoMemory.WRAPPER}Mixin.instanceData(this,"AutoMemory").push(new Mixin.AutoMemory.WrappedProperty(this,a,b,c));return this},autoFunction:function(a,b){Mixin.instanceData(this,"AutoMemory").push(new Mixin.AutoMemory.Function(a,b,Array.prototype.slice.call(arguments,2)));return this}}};Mixin.registerMixin(Mixin.AutoMemory._mixin_info);