// Generated by CoffeeScript 1.3.3
/*
  mixin_subscriptions.js
  (c) 2011 Kevin Malakoff.
  Mixin.Subscriptions is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/mixin/blob/master/LICENSE
  Dependencies: Mixin.Core, Underscore.js, Underscore-Awesomer.js
*/(function(){var e;!Mixin&&typeof exports!="undefined"&&(this.Mixin=require("mixin_core").Mixin),e=!window._&&typeof require!="undefined"?require("underscore"):window._,e||(e=Mixin._),Mixin.Subscriptions||(Mixin.Subscriptions={}),Mixin.Subscriptions._SubscriptionLink=function(){function t(t,n,r,i){var s;this.subscription=t,this.subscriber=n,this.notification_callback=r,this.options=e.clone(i||{}),s=Mixin.instanceData(this.subscriber,"Subscriber"),s.subscription_backlinks.push(this)}return t.prototype.mustKeepUntilDestroyed=function(){return this.options.keep_until_destroyed===void 0||!this.options.keep_until_destroyed},t.prototype.destroy=function(){var t;if(!this.subscription)throw new Error("Mixin.Subscriptions: _SubscriptionLink destroyed multiple times");return this.options.destroy&&(this.options.destroy(),this.options.destroy=null),t=Mixin.instanceData(this.subscriber,"Subscriber"),e.remove(t.subscription_backlinks,this),e.remove(this.subscription.subscription_links,this),this.subscription=null,this.subscriber=null,this.notification_callback=null,this.options=null},t}(),Mixin.Subscription||(Mixin.Subscription={}),Mixin.Subscription.TYPE={},Mixin.Subscription.TYPE.MULTIPLE=0,Mixin.Subscription.TYPE.EXCLUSIVE=1,Mixin.Subscriptions._Subscription=function(){function t(e,t){this.observable=e,this.subscription_type=t;if(Mixin.DEBUG)if(typeof this.subscription_type!="number"||this.subscription_type<Mixin.Subscription.TYPE.MULTIPLE||this.subscription_type>Mixin.Subscription.TYPE.EXCLUSIVE)throw new Error("Mixin.Subscriptions: Mixin.Subscription.TYPE is invalid");this.subscription_links=[]}return t.prototype.addSubscriber=function(e,t,n){return this.subscription_type===Mixin.Subscription.TYPE.EXCLUSIVE&&this.removeSubscribers(function(e){return e.mustKeepUntilDestroyed()}),this.subscription_links.push(new Mixin.Subscriptions._SubscriptionLink(this,e,t,n))},t.prototype.removeSubscriber=function(t,n,r){var i;i=e.find(this.subscription_links,function(e){return t===e.subscriber&&n===e.notification_callback});if(!i)throw new Error("Mixin.Subscriptions.removeSubscriber: subscription '"+r+"' does not exist for '"+e.classOf(t)+"'");return e.remove(this.subscription_links,i),i.destroy()},t.prototype.subscribers=function(e){var t,n,r,i,s;i=this.subscription_links,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(e.push(t.subscriber));return s},t.prototype.notifySubscribers=function(){var e,t,n,r,i,s;e=Array.prototype.slice.call(arguments),i=this.subscription_links,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.notification_callback.apply(t.subscriber,e));return s},t.prototype.removeSubscribers=function(t){var n,r,i,s,o,u,a,f;if(t){n=e.select(this.subscription_links,t);if(n.length===0)return;this.subscription_links=e.difference(this.subscription_links,n),a=[];for(i=0,o=n.length;i<o;i++)r=n[i],a.push(r.destroy());return a}n=this.subscription_links,this.subscription_links=[],f=[];for(s=0,u=n.length;s<u;s++)r=n[s],f.push(r.destroy());return f},t.prototype.destroy=function(){var e,t,n,r,i;t=this.subscription_links,this.subscription_links=[],i=[];for(n=0,r=t.length;n<r;n++)e=t[n],i.push(e.destroy());return i},t}(),Mixin.Subscriptions.Observable||(Mixin.Subscriptions.Observable={}),Mixin.Subscriptions.Observable._mixin_info={mixin_name:"Observable",initialize:function(){var t,n,r,i;Mixin.instanceData(this,"Observable",{subscriptions:{},is_destroyed:!1}),i=[];for(n=0,r=arguments.length;n<r;n++)t=arguments[n],i.push(this.publishSubscription.apply(this,e.isArray(t)?t:[t]));return i},destroy:function(){var e,t,n,r,i,s;e=Mixin.instanceData(this,"Observable");if(e.is_destroyed)throw new Error("Mixin.Observable.destroy: already destroyed");e.is_destroyed=!0,n=e.subscriptions,e.subscriptions=[],s=[];for(r=0,i=n.length;r<i;r++)t=n[r],s.push(t.destroy());return s},mixin_object:{hasSubscription:function(e){var t;return Mixin.DEBUG&&Mixin.Core._Validate.string(e,"Mixin.Observable.hasSubscription","subscription_name"),t=Mixin.instanceData(this,"Observable"),t.subscriptions.hasOwnProperty(e)},publishSubscription:function(e,t){var n;return n=Mixin.instanceData(this,"Observable"),t===void 0&&(t=Mixin.Subscription.TYPE.MULTIPLE),Mixin.DEBUG&&(Mixin.Core._Validate.string(e,"Mixin.Observable.publishSubscription","subscription_name"),Mixin.Core._Validate.noKey(n.subscriptions,e,"Mixin.Observable.publishSubscription","subscription_name")),n.subscriptions[e]=new Mixin.Subscriptions._Subscription(this,t),this},subscriptions:function(){var e,t,n,r,i;e=Mixin.instanceData(this,"Observable"),n=[],i=e.subscriptions;for(t in i)r=i[t],n.push(t);return n},subscribers:function(t){var n,r,i,s,o,u;i=[],n=Mixin.instanceData(this,"Observable");if(t===void 0){o=n.subscriptions;for(r in o)s=o[r],s.subscribers(i)}else{if(!n.subscriptions.hasOwnProperty(t))throw new Error("Mixin.Observable.subscribers: subscriber '"+_classOf(this)+"' does not recognize '"+t+"'");u=n.subscriptions;for(r in u)s=u[r],s.subscription_name===t&&s.subscribers(i)}return e.uniq(i)},addSubscriber:function(t,n){var r,i,s,o,u,a,f;s=Mixin.instanceData(this,"Observable"),u=function(e,n,r){var i;return r||(r={}),Mixin.DEBUG&&(Mixin.Core._Validate.string(e,"Mixin.Observable.addSubscriber","subscription_name"),Mixin.Core._Validate.callback(n,"Mixin.Observable.addSubscriber","notification_callback"),Mixin.Core._Validate.object(r,"Mixin.Observable.addSubscriber","options"),r.destroy!==void 0&&Mixin.Core._Validate.callback(r.destroy,"Mixin.Observable.addSubscriber","options.destroy")),Mixin.Core._Validate.hasKey(s.subscriptions,e,"Mixin.Observable.addSubscriber","subscription_name"),i=s.subscriptions[e],i.addSubscriber(t,n,r)},r=Array.prototype.slice.call(arguments,1),Mixin.Core._Validate.instanceWithMixin(t,"Subscriber","Mixin.Observable.addSubscriber","subscriber");if(r.length>1){i=r[1];if(!(e.isString(i)&&this.hasSubscription(i)||e.isArray(i)&&i.length>=1&&e.isString(i[0])&&this.hasSubscription(i[0])))return u.apply(this,Array.prototype.slice.call(arguments,1)),this}for(a=0,f=r.length;a<f;a++)o=r[a],e.isArray(o)?u.apply(this,o):u.apply(o);return this},notifySubscribers:function(e){var t,n;t=Mixin.instanceData(this,"Observable");if(t.is_destroyed)return;Mixin.DEBUG&&(Mixin.Core._Validate.string(e,"Mixin.Observable.notifySubscribers","subscription_name"),Mixin.Core._Validate.hasKey(t.subscriptions,e,"Mixin.Observable.notifySubscribers")),n=t.subscriptions[e];if(!n)return;return n.notifySubscribers.apply(n,Array.prototype.slice.call(arguments,1)),this},removeSubscriber:function(t,n,r){var i,s,o,u,a,f,l;o=Mixin.instanceData(this,"Observable"),a=function(e,n){var r;return Mixin.DEBUG&&(Mixin.Core._Validate.string(e,"Mixin.Observable.removeSubscriber","subscription_name"),Mixin.Core._Validate.callback(n,"Mixin.Observable.removeSubscriber","notification_callback")),Mixin.Core._Validate.hasKey(o.subscriptions,e,"Mixin.Observable.removeSubscriber","subscription_name"),r=o.subscriptions[e],r.removeSubscriber(t,n,e)},i=Array.prototype.slice.call(arguments,1),Mixin.DEBUG&&Mixin.Core._Validate.instanceWithMixin(t,"Subscriber","Mixin.Observable.removeSubscriber","subscriber");if(i.length>1){s=i[1];if(!(e.isString(s)&&this.hasSubscription(s)||e.isArray(s)&&s.length>=1&&e.isString(s[0])&&this.hasSubscription(s[0])))return a.apply(this,Array.prototype.slice.call(arguments,1)),this}for(f=0,l=i.length;f<l;f++)u=i[f],e.isArray(u)?a.apply(this,u):a.apply(u);return this},removeSubscribers:function(e,t){var n,r,i,s;n=Mixin.instanceData(this,"Observable"),Mixin.DEBUG&&(e!==void 0&&(Mixin.Core._Validate.string(e,"Mixin.Observable.removeSubscribers","subscription_name"),Mixin.Core._Validate.hasKey(n.subscriptions,e,"Mixin.Observable.removeSubscribers")),t!==void 0&&Mixin.Core._Validate.callback(t,"Mixin.Observable.removeSubscribers","test_fn"));if(e){i=n.subscriptions[e];if(!i)return;i.removeSubscribers(t)}else{s=n.subscriptions;for(r in s)i=s[r],i.removeSubscribers(t)}return this}}},Mixin.Subscriptions.Subscriber||(Mixin.Subscriptions.Subscriber={}),Mixin.Subscriptions.Subscriber._mixin_info={mixin_name:"Subscriber",initialize:function(){return Mixin.instanceData(this,"Subscriber",{subscription_backlinks:[],is_destroyed:!1})},destroy:function(){var e,t,n,r,i,s;n=Mixin.instanceData(this,"Subscriber");if(n.is_destroyed)throw new Error("Mixin.Subscriber.destroy: already destroyed");n.is_destroyed=!0,t=n.subscription_backlinks,n.subscription_backlinks=[],s=[];for(r=0,i=t.length;r<i;r++)e=t[r],s.push(e.destroy());return s},mixin_object:{observables:function(t){var n,r,i,s,o,u,a,f,l;n=Mixin.instanceData(this,"Subscriber"),r=[];if(t===void 0){f=n.subscription_backlinks;for(s=0,u=f.length;s<u;s++)i=f[s],i.subscription&&i.subscription.subscription_name===t&&r.push(i.subscription.observable)}else{Mixin.DEBUG&&Mixin.Core._Validate.string(t,"Mixin.Subscriptions.observables","subscription_name"),l=n.subscription_backlinks;for(o=0,a=l.length;o<a;o++)i=l[o],i.subscription&&r.push(i.subscription.observable)}return e.uniq(r)}}},Mixin.Subscriptions.ObservableSubscriber||(Mixin.Subscriptions.ObservableSubscriber={}),Mixin.Subscriptions.ObservableSubscriber._mixin_info={mixin_name:"ObservableSubscriber",mixin_object:{},initialize:function(){return Mixin["in"](this,"Subscriber",["Observable"].concat(Array.prototype.slice.call(arguments)))},destroy:function(){return Mixin.out(this,"Subscriber","Observable")}},Mixin.registerMixin(Mixin.Subscriptions.Observable._mixin_info),Mixin.registerMixin(Mixin.Subscriptions.Subscriber._mixin_info),Mixin.registerMixin(Mixin.Subscriptions.ObservableSubscriber._mixin_info)}).call(this);