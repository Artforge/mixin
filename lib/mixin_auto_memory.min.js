// Generated by CoffeeScript 1.3.3
/*
  mixin_auto_memory.js
  (c) 2011 Kevin Malakoff.
  Mixin.AutoMemory is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/mixin/blob/master/LICENSE
  Dependencies: Mixin.Core, Underscore.js, Underscore-Awesomer.js
*/(function(){var e;!Mixin&&typeof exports!="undefined"&&(this.Mixin=require("mixin_core").Mixin),e=!window._&&typeof require!="undefined"?require("underscore"):window._,e||(e=Mixin._),Mixin.AutoMemory||(Mixin.AutoMemory={}),Mixin.AutoMemory.root=this,Mixin.AutoMemory.WRAPPER=Mixin.AutoMemory.root.$?$:"$",Mixin.AutoMemory.Property=function(){function t(e){this.owner=e}return t.prototype.setArgs=function(){var t,n,r,i,s;if(!arguments.length)throw new Error("Mixin.AutoMemory: missing key");this.args=Array.prototype.slice.call(arguments);if(!Mixin.DEBUG)return this;if(e.isArray(this.args[0])){i=this.args,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(this._validateEntry(t));return s}return this._validateEntry(this.args)},t.prototype.destroy=function(){var t,n,r,i,s;if(e.isArray(this.args[0])){i=this.args,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(this._destroyEntry(t));return s}return this._destroyEntry(this.args)},t.prototype._validateEntry=function(t){var n,r;r=t[0],n=t.length>1?t[1]:void 0;if(!e.keypathExists(this.owner,r))throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+e.classOf(this.owner)+"'");if(n&&!e.isFunction(n)&&!e.isString(n))throw new Error("Mixin.AutoMemory: unexpected function reference for property '"+r+"' on '"+e.classOf(this.owner)+"'")},t.prototype._destroyEntry=function(t){var n,r,i,s,o,u,a,f;r=t[0],n=t.length>1?t[1]:void 0;if(!n){i=e.keypathValueOwner(this.owner,r);if(!i)throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+e.classOf(this.owner)+"'");i[r]=null;return}o=e.keypath(this.owner,r);if(!o)return;if(e.isFunction(n))n.apply(this.owner,[o].concat(t.length>2?t.slice(2):[]));else if(e.isFunction(o[n]))o[n].apply(o,t.length>2?t.slice(2):[]);else{f=t.slice(1);for(u=0,a=f.length;u<a;u++)s=f[u],this._destroyEntry([s])}return e.keypath(this.owner,r,null)},t}(),Mixin.AutoMemory.WrappedProperty=function(){function t(t,n,r,i){var s,o,u;this.owner=t,this.key=n,this.fn_ref=r,this.wrapper=i;if(this.fn_ref&&e.isArray(this.fn_ref)){if(Mixin.DEBUG&&!this.fn_ref.length)throw new Error("Mixin.AutoMemory: unexpected function reference");this.args=this.fn_ref.splice(1),this.fn_ref=this.fn_ref[0]}if(!Mixin.DEBUG)return this;if(!this.key)throw new Error("Mixin.AutoMemory: missing key");if(e.isArray(this.key)){u=this.key;for(s=0,o=u.length;s<o;s++){n=u[s];if(!e.keypathExists(this.owner,n))throw new Error("Mixin.AutoMemory: property '"+n+"' doesn't exist on '"+e.classOf(this.owner)+"'")}}else if(!e.keypathExists(this.owner,this.key))throw new Error("Mixin.AutoMemory: property '"+this.key+"' doesn't exist on '"+e.classOf(this.owner)+"'");if(this.fn_ref&&!e.isFunction(this.fn_ref)&&!e.isString(this.fn_ref))throw new Error("Mixin.AutoMemory: unexpected function reference");if(!this.wrapper)throw new Error("Mixin.AutoMemory: missing wrapper")}return t.prototype.destroy=function(){var t,n,r,i,s;if(e.isArray(this.key)){i=this.key,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(this._destroyKey(t));return s}return this._destroyKey(this.key)},t.prototype._destroyKey=function(t){var n,r,i;if(!this.fn_ref){e.keypath(this.owner,t,null);return}n=e.keypath(this.owner,t);if(!n)return;i=e.isString(this.wrapper)?Mixin.AutoMemory.root[this.wrapper]:this.wrapper,r=i(n);if(e.isFunction(this.fn_ref))this.fn_ref.apply(this.owner,[r].concat(this.args?this.args.slice():[]));else{if(Mixin.DEBUG&&!e.isFunction(r[this.fn_ref]))throw new Error("Mixin.AutoMemory: function '"+this.fn_ref+"' missing for wrapped property '"+t+"' on '"+e.classOf(this.owner)+"'");r[this.fn_ref].apply(r,this.args)}return e.keypath(this.owner,t,null)},t}(),Mixin.AutoMemory.Function=function(){function t(t,n,r){this.object=t,this.fn_ref=n,this.args=r;if(!Mixin.DEBUG)return this;if(!this.fn_ref)throw new Error("Mixin.AutoMemory: missing fn_ref");if(!e.isFunction(this.fn_ref)&&!(this.object&&e.isString(this.fn_ref)&&e.isFunction(this.object[this.fn_ref])))throw new Error("Mixin.AutoMemory: unexpected function reference")}return t.prototype.destroy=function(){if(!this.object){this.fn_ref.apply(null,this.args);return}if(!e.isFunction(this.fn_ref)){this.object[this.fn_ref].apply(this.object,this.args);return}return this.fn_ref.apply(this.object,[this.object].concat(this.args?this.args.slice():[]))},t}(),Mixin.AutoMemory._mixin_info={mixin_name:"AutoMemory",initialize:function(){return Mixin.instanceData(this,"AutoMemory",[])},destroy:function(){var e,t,n,r,i;t=Mixin.instanceData(this,"AutoMemory"),Mixin.instanceData(this,"AutoMemory",[]),i=[];for(n=0,r=t.length;n<r;n++)e=t[n],i.push(e.destroy());return i},mixin_object:{autoProperty:function(e,t){var n;return n=new Mixin.AutoMemory.Property(this),n.setArgs.apply(n,arguments),Mixin.instanceData(this,"AutoMemory").push(n),this},autoWrappedProperty:function(e,t,n){return n===void 0&&(n=Mixin.AutoMemory.WRAPPER),Mixin.instanceData(this,"AutoMemory").push(new Mixin.AutoMemory.WrappedProperty(this,e,t,n)),this},autoFunction:function(e,t){return Mixin.instanceData(this,"AutoMemory").push(new Mixin.AutoMemory.Function(e,t,Array.prototype.slice.call(arguments,2))),this}}},Mixin.registerMixin(Mixin.AutoMemory._mixin_info)}).call(this);